package main

import (
	"path"

	"github.com/anchore/go-sync"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/cve"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/nvd"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/search"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/util"
)

func processInputsToIndexes(executor sync.Executor, nvdDbFile, cveListDir string) search.Indexes {
	var timer = util.NewStopwatch()

	knownRecords := cve.ReadSingleIDProducts(executor, path.Join(cveListDir, "*/**/*.json"))
	util.Log("cve individual record count: %v took: %v", len(knownRecords), timer.Lap())

	cveToID := nvd.GetKnownCveToSingleIDs(nvdDbFile)
	util.Log("read nvd cpe records db in %v", timer.Lap())

	knownRecords = filterKnownRecordsToSingleCpe(cveToID, knownRecords)
	util.Log("filtered to single-cpe known records; count: %v took: %v", len(knownRecords), timer.Lap())

	indexes := search.BuildIndexes(knownRecords)
	util.Log("build indexes took:", timer.Lap())

	return indexes
}

func filterKnownRecordsToSingleCpe(cveToID map[string][]string, records []cve.Rec) []cve.Rec {
	var out []cve.Rec
	for _, r := range records {
		r, ok := filterKnownRecordToSingleCpe(cveToID, r)
		if ok {
			out = append(out, r)
		}
	}
	return out
}

func filterKnownRecordToSingleCpe(cveToIDs map[string][]string, r cve.Rec) (cve.Rec, bool) {
	if r.ID != "" {
		// already set, use it
		return r, true
	}

	if len(cveToIDs[r.Cve]) != 1 {
		// none or too many values to know the right one
		return r, false
	}

	// exactly 1 record, use it
	r.ID = cveToIDs[r.Cve][0]

	return r, true
}

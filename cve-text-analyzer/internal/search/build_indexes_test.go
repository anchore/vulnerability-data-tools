package search

import (
	"testing"

	"github.com/stretchr/testify/require"

	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/cve"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/termset"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/util"
)

func Test_BuildIndexes(t *testing.T) {
	recs := []cve.Rec{
		{
			Cve: "cve-1234-1234",
			Cpe: "c:p:e",
			Text: []string{
				"a",
			},
		},
	}

	indexes := BuildIndexes(recs)

	prod := &Product{
		Cpe: "c:p:e",
		//cpeTerms:   nil,
		//cveMaxYear: 0,
		Cves: util.NewSet("cve-1234-1234"),
		Terms: termset.Set{
			"a": 1,
		},
		Weights: termset.Set{
			"a": 1,
		},
	}

	expected := Indexes{
		termsToProducts: map[string]util.Set[*Product]{
			"a": util.NewSet[*Product](prod),
		},
		allProducts: util.NewSet[*Product](prod),
	}

	require.EqualValues(t, expected, indexes)
}

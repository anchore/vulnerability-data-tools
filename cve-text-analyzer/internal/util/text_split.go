package util

import (
	"regexp"
	"strings"

	"github.com/fatih/camelcase"

	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/termset"
)

// GetTextTerms processes the text, returning a searchable set of individual terms
func GetTextTerms(t string) termset.Set {
	// split urls based on segments, e.g. github.com/org/repo will have distinct tokens
	t = urlPat.ReplaceAllStringFunc(t, func(s string) string {
		parts := urlSplitter.Split(t, -1)
		if !keepHosts.Has(parts[0]) {
			return ""
		}
		return strings.Join(parts, " ")
	})

	out := termset.Set{}

	for _, term := range Whitespace.Split(t, -1) {
		// each word we get like some.thing some-thing some_thing split into separate words "some thing" and combine to "something"
		appendVariation(out, term)
		for _, part := range camelcase.Split(term) {
			appendVariation(out, part)
		}
		for _, part := range DisallowedChars.Split(term, -1) {
			appendVariation(out, part)
		}
	}

	out.SetAll(1)
	return out
}

func appendVariation(terms termset.Set, term string) {
	term = strings.ToLower(term)
	term = DisallowedChars.ReplaceAllString(term, "")
	if term == "" || IsHashLike(term) {
		return
	}
	terms.Add(term)
}

var urlPat = regexp.MustCompile(`https?://[^\s]+`)
var urlSplitter = regexp.MustCompile(`[./]`)

var keepHosts = termset.New(
	"github.com",
)

func isKnownVersionType(versionType string) bool {
	versionType = strings.ToLower(versionType)
	switch versionType {
	case "general", "release", "patch", "python", "rpm", "affected", "general availability", "semver", "maven", "original_commit_for_fix":
		return true
	default:
		return false
	}
}

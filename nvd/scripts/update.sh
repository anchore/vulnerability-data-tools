#!/bin/bash -l

mkdir .tmp

curl --fail --location --output .tmp/official-cpe-dictionary_v2.3.xml.gz --request GET https://nvd.nist.gov/feeds/xml/cpe/dictionary/official-cpe-dictionary_v2.3.xml.gz
gzip --decompress --force .tmp/official-cpe-dictionary_v2.3.xml.gz

crane export ghcr.io/anchore/grype-db/data/nvd:latest - | tar -Oxf - nvd/input/nvd-input.db > .tmp/nvd-input.db
crane export ghcr.io/anchore/grype-db/data/nvd:latest - | tar -Oxf - nvd/results/results.db > .tmp/nvd-result.db
crane export ghcr.io/anchore/grype-db/data/github:latest - | tar -Oxf - github/results/results.db > .tmp/github-result.db

git -C ".tmp/github-advisory-database" pull || git clone --depth 1 https://github.com/github/advisory-database .tmp/github-advisory-database
git -C ".tmp/national-vulnerability-database" pull || git clone --depth 1 https://github.com/westonsteimel/national-vulnerability-database .tmp/national-vulnerability-database
git -C ".tmp/cvelist-v5" pull || git clone --depth 1 https://github.com/CVEProject/cvelistV5 .tmp/cvelist-v5
git -C ".tmp/linux-kernel-vulns" pull || git clone --depth 1 https://git.kernel.org/pub/scm/linux/security/vulns.git .tmp/linux-kernel-vulns
git -C ".tmp/nvd-data-overrides" pull || git clone --depth 1 https://github.com/anchore/nvd-data-overrides .tmp/nvd-data-overrides

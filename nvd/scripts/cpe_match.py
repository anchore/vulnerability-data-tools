import json
import uuid

from copy import deepcopy
from glob import glob

namespace = uuid.uuid5(uuid.NAMESPACE_URL, "https://github.com/anchore/nvd-data-overrides")


class MatchCriteriaIdGenerator:
    def __init__(self):
        self._nvd_known_id_lookup = None

    def _load_known_nvd_id_lookups(self):
        self._nvd_known_id_lookup: dict[str, str] = {}

        for nvd_file in glob("national-vulnerability-database/data/**/CVE-*.json", recursive=True):
            with open(nvd_file) as f:
                data = json.load(f)

            cpe_configs = data.get("cve", {}).get("configurations", [])

            for c in cpe_configs:
                for n in c.get("nodes", []):
                    for m in n.get("cpeMatch", []):
                        match_id = m["matchCriteriaId"]
                        del m["matchCriteriaId"]
                        del m["vulnerable"]
                        self._nvd_known_id_lookup[json.dumps(m, sort_keys=True)] = match_id

    def generate(self, match_criteria: dict) -> str:
        """
        Creates a stable UUID for a given set of match criteria.  It will use any known values from the NVD
        before attempting to create a new one. If in future we discover exactly how the NVD 
        generation works then in theory we should be able to exactly match any of their existing ids, 
        but I have not found any documentation around that so far.  This will ensure they at least 
        match across the override dataset.  We are not using the criteriaMatchId for anything, but others 
        might so we'll at least make them non-random  
        """
        data = deepcopy(match_criteria)
        if self._nvd_known_id_lookup is None:
            self._load_known_nvd_id_lookups()

        if "matchCriteriaId" in data:
            del data["matchCriteriaId"]

        if "vulnerable" in data:
            del data["vulnerable"]

        s = json.dumps(data, sort_keys=True)
        return self._nvd_known_id_lookup.get(s, str(uuid.uuid5(namespace, s))).upper()


if __name__ == "__main__":
    id_to_things: dict[str, set[str]] = {}

    for nvd_file in glob("national-vulnerability-database/data/**/CVE-*.json", recursive=True):
        with open(nvd_file) as f:
            data = json.load(f)

        cpe_configs = data.get("cve", {}).get("configurations", [])

        for c in cpe_configs:
            for n in c.get("nodes", []):
                for m in n.get("cpeMatch", []):
                    match_id = m["matchCriteriaId"]
                    del m["matchCriteriaId"]
                    del m["vulnerable"]

                    if match_id not in id_to_things:
                        id_to_things[match_id] = set()
                    id_to_things[match_id].add(json.dumps(m, sort_keys=True))

    for k, v in id_to_things.items():
        if len(v) > 1:
            print(f"{k}: {list(v)}")

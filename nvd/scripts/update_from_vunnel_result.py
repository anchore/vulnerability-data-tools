import os
import sqlite3
from json import loads, dump

# This relies on having the grype-db repo cloned locally and running 
# `make download-all-provider-cache` from the grype-db repo root
# prior to executing 

def update_nvd_data(db_path: str):
    con = sqlite3.connect(db_path)
    for row in con.cursor().execute("SELECT record from results;"):
        nvd_json = loads(row[0])["item"]
        cve_id = nvd_json["cve"]["id"]
        year = cve_id.split("-")[1]
        path = os.path.join("data", year)
        os.makedirs(path, exist_ok=True)

        with open(os.path.join(path, f"{cve_id}.json"), "w") as f:
            dump(nvd_json, f, indent=2)

update_nvd_data("/Users/weston/github/anchore/grype-db/data/vunnel/nvd/input/nvd-input.db")

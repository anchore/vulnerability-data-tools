import copy
import json

from glob import glob

from scripts.cpe_match import generate_match_criteria_id

def update_match_criteria_ids():
    for override_file in glob("nvd-data-overrides/data/**/CVE-*.json", recursive=True):
        with open(override_file, "r") as f:
            override_data = json.load(f)
        
        updated_data = copy.deepcopy(override_data)
        cpe_configs = override_data.get("cve", {}).get("configurations")

        if not cpe_configs:
            continue

        for ci, c in enumerate(cpe_configs):
            for ni, n in enumerate(c.get("nodes", [])):
                for mi, m in enumerate(n.get("cpeMatch", [])):
                    t = copy.deepcopy(m)
                    del t["matchCriteriaId"]
                    updated_data["cve"]["configurations"][ci]["nodes"][ni]["cpeMatch"][mi]["matchCriteriaId"] = str(generate_match_criteria_id(t)).upper()

        if updated_data == override_data:
            continue

        with open(override_file, "w") as f:
            json.dump(updated_data, f, sort_keys=True, indent=2)


if __name__ == '__main__':
    update_match_criteria_ids()

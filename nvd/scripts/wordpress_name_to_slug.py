# Queries wordpress.org to generate a lookup of plugin name to slug and theme name to slug

import json
import os
import requests

from scripts.normalization import normalize

url_format = "https://api.wordpress.org/{wp_type}/info/1.2/?action=query_{wp_type}&request[page]={page}&request[per_page]=1000000"

for t in ["plugins", "themes"]:
    path = f"data/wordpress/{t}/by_name.json"
    by_name = {}
    if os.path.exists(path):
        with open(path, "r") as f:
            by_name = json.load(f)

    current_page = 1
    data = requests.get(url_format.format(wp_type=t, page=current_page)).json()
    pages = data["info"]["pages"]
    
    while current_page < pages + 1:
        for plugin in data[t]:
            by_name[normalize(plugin["name"])] = plugin["slug"]

        current_page += 1
        if current_page <= pages:
            data = requests.get(url_format.format(wp_type=t, page=current_page)).json()

    with open(path, "w") as f:
        by_name = json.dump(by_name, f, sort_keys=True, indent=2)
